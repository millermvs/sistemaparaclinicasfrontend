<div class="container-fluid consultas-page">
  <!-- TÍTULO + BOTÃO NOVO -->
  <div class="row mb-4">
    <div class="col">
      <h2 class="mb-0">Consultas</h2>
      <small class="text-muted">Gerencie as consultas agendadas na clínica</small>
    </div>

    <div class="col-auto d-flex align-items-center">
      <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalCadastroConsulta">
        + Nova Consulta
      </button>
    </div>
  </div>

  <!-- CARD DE FILTRO -->
  <div class="card mb-4">
    <div class="card-header text-center">
      <span class="fw-bold fs-5">Filtrar consultas</span>
    </div>

    <div class="card-body">
      <!-- FILTRO POR PERÍODO (ainda não ligado no TS, foco agora é paginação) -->
      <form [formGroup]="formBuscarConsultasPorDatas" (ngSubmit)="buscarConsultas(0)"
        class="row g-3 align-items-end justify-content-center text-center mb-3">
        <!-- DATA INÍCIO -->
        <div class="col-12 col-sm-4 col-md-3">
          <label for="dataInicio" class="form-label">Data início</label>
          <input type="date" id="dataInicio" class="form-control" formControlName="dataInicio" />
        </div>

        <!-- DATA FIM -->
        <div class="col-12 col-sm-4 col-md-3">
          <label for="dataFim" class="form-label">Data fim</label>
          <input type="date" id="dataFim" class="form-control" formControlName="dataFim"
            [min]="formBuscarConsultasPorDatas.get('dataInicio')?.value" />
        </div>

        <!-- MÉDICO -->
        <div class="col-12 col-sm-4 col-md-3">
          <label class="form-label">Médico</label>
          <select class="form-select" formControlName="idMedico">

            <option value='' disabled>Selecione um médico</option>

            <option *ngFor="let m of medicosModal()" [value]="m.idMedico">
              {{ m.nomeMedico }}
            </option>
          </select>
        </div>

        <!-- BOTÕES -->
        <div class="col-12 col-sm-4 col-md-3 d-flex gap-2 justify-content-center">
          <button type="submit" class="btn btn-dark mt-4" [disabled]="formBuscarConsultasPorDatas.invalid">
            Filtrar
          </button>

          <button type="button" class="btn btn-outline-secondary mt-4" (click)="limparformBuscarConsultasPorDatas()">
            Limpar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Mensagem de alerta -->
  <div *ngIf="mensagemPagPrincipal()!=''" class="alert alert-{{tipoMensagem()}} alert-dismissible fade show">
    <strong>{{mensagemPagPrincipal()}}</strong>
    <button type="button" class="btn-close" aria-label="Close" (click)="mensagemPagPrincipal.set('')"></button>
  </div>

  <!-- LISTA DE CONSULTAS -->
  <div class="row">
    <div class="col-12">
      <div class="card">

        <!-- CABEÇALHO DA TABELA -->
        <div class="card-header text-center fw-bold fs-5">
          Consultas agendadas
        </div>

        <!-- TABELA DE CONSULTAS -->
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Médico</th>
                  <th>Paciente</th>
                  <th>Data</th>
                  <th>Hora</th>
                  <th>Status</th>
                  <th style="width: 220px;">Ações</th>
                </tr>
              </thead>

              <tbody>
                <!-- Agora dinâmico com paginação -->
                <tr *ngFor="let consulta of consultas()">
                  <td>{{ consulta.nomeMedico }}</td>
                  <td>{{ consulta.nomePaciente }}</td>
                  <td>{{ consulta.dataConsulta | date:'dd/MM/yyyy' }}</td>
                  <td>{{ consulta.horaConsulta }}</td>
                  <td>
                    <span class="badge" [ngClass]="{
                            'text-bg-success': consulta.status === 'AGENDADA',
                            'text-bg-primary': consulta.status === 'CONFIRMADA',
                            'text-bg-secondary': consulta.status === 'REALIZADA',
                            'text-bg-danger': consulta.status === 'CANCELADA'
                          }">
                      {{ consulta.status | titlecase }}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-outline-warning">
                        Remarcar
                      </button>
                      <button class="btn btn-sm btn-outline-danger">
                        Cancelar
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>

            </table>
          </div>
        </div>

        <!-- PAGINAÇÃO DARK PREMIUM (padrão Pacientes) -->
        <nav class="pagination-container" *ngIf="totalPaginas() > 1">
          <ul class="pagination-dark">

            <!-- Botão Anterior -->
            <li>
              <button class="page-btn" [class.disabled]="paginaAtual() === 0" (click)="irParaPagina(paginaAtual() - 1)">
                <i class="bi bi-chevron-left"></i>
              </button>
            </li>

            <!-- Números -->
            <li *ngFor="let page of totalPaginasArray()">
              <button class="page-btn" [class.active]="page === paginaAtual()" (click)="irParaPagina(page)">
                {{ page + 1 }}
              </button>
            </li>

            <!-- Botão Próximo -->
            <li>
              <button class="page-btn" [class.disabled]="paginaAtual() === totalPaginas() - 1"
                (click)="irParaPagina(paginaAtual() + 1)">
                <i class="bi bi-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>

      </div>
    </div>
  </div>
</div>

<!-- MODAL DE CADASTRO DE CONSULTA -->
<div class="modal fade" id="modalCadastroConsulta" tabindex="-1" (hidden.bs.modal)="limparModal()">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <!-- Cabeçalho -->
      <div class="modal-header">
        <h5 class="modal-title">Cadastrar Consulta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Corpo -->
      <div class="modal-body">
        <form [formGroup]="formCadastroConsulta">
          <!-- Médico -->
          <div class="mb-3">
            <label class="form-label">Médico</label>
            <select class="form-select" formControlName="idMedico"
              [class.is-invalid]="formCadastroConsulta.get('idMedico')?.invalid && formCadastroConsulta.get('idMedico')?.touched">

              <option value="" disabled>Selecione um médico</option>

              <option *ngFor="let m of medicosModal()" [value]="m.idMedico">
                {{ m.nomeMedico }}
              </option>
            </select>

            <div class="invalid-feedback"
              *ngIf="formCadastroConsulta.get('idMedico')?.hasError('required') && formCadastroConsulta.get('idMedico')?.touched">
              Médico é obrigatório.
            </div>
          </div>

          <!-- Paciente -->
          <div class="mb-3">
            <label class="form-label">Paciente</label>

            <div [formGroup]="formBuscarPacienteModal" class="d-flex gap-2 mb-2">
              <input type="text" class="form-control" placeholder="Digite o nome do paciente"
                formControlName="nomePaciente">

              <button type="button" class="btn btn-dark" (click)="buscarPacientesModal()"
                [disabled]="formBuscarPacienteModal.invalid">
                Buscar
              </button>
            </div>

            <select class="form-select" formControlName="idPaciente"
              [class.is-invalid]="formCadastroConsulta.get('idPaciente')?.invalid && formCadastroConsulta.get('idPaciente')?.touched">
              <option value="" disabled>Selecione um paciente</option>

              <option *ngFor="let p of pacientesModal()" [value]="p.idPaciente">
                {{ p.nomePaciente }} - {{ aplicarMascaraCPF(p.cpfPaciente) }}
              </option>
            </select>

            <div class="invalid-feedback"
              *ngIf="formCadastroConsulta.get('idPaciente')?.hasError('required') && formCadastroConsulta.get('idPaciente')?.touched">
              Paciente é obrigatório.
            </div>

            <div class="form-text">
              Digite parte do nome e clique em <strong>Buscar</strong>.
            </div>
          </div>

          <!-- Data -->
          <div class="mb-3">
            <label class="form-label">Data da consulta</label>
            <input type="date" class="form-control" formControlName="dataConsulta" [min]="hoje"
              [class.is-invalid]="formCadastroConsulta.get('dataConsulta')?.invalid && formCadastroConsulta.get('dataConsulta')?.touched">

            <div class="invalid-feedback"
              *ngIf="formCadastroConsulta.get('dataConsulta')?.hasError('required') && formCadastroConsulta.get('dataConsulta')?.touched">
              Data da consulta é obrigatória.
            </div>
          </div>

          <!-- Hora -->
          <div class="mb-3">
            <label class="form-label">Hora da consulta</label>
            <select class="form-select" formControlName="horaConsulta"
              [class.is-invalid]="formCadastroConsulta.get('horaConsulta')?.invalid && formCadastroConsulta.get('horaConsulta')?.touched">
              <option value="" disabled>Selecione o horário</option>

              <option *ngFor="let hora of horariosDisponiveis">
                {{ hora }}
              </option>
            </select>

            <div class="invalid-feedback"
              *ngIf="formCadastroConsulta.get('horaConsulta')?.hasError('required') && formCadastroConsulta.get('horaConsulta')?.touched">
              Hora da consulta é obrigatória.
            </div>
          </div>
        </form>

        <!-- Mensagem retorno -->
        <div [ngClass]="{ 'show': mensagemModal() != '' }"
          class="alert alert-{{ tipoMensagem() }} alert-dismissible fade show" *ngIf="mensagemModal() != ''">
          <strong>{{ mensagemModal() }}</strong>
          <button type="button" class="btn-close" aria-label="Close" (click)="mensagemModal.set('')"></button>
        </div>
      </div>

      <!-- Rodapé -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger mt-4" data-bs-dismiss="modal">
          Cancelar
        </button>

        <button type="button" class="btn btn-dark mt-4" (click)="salvarConsulta()"
          [disabled]="formCadastroConsulta.invalid">
          Salvar
        </button>

        <button #btnCloseSalvar type="button" class="d-none" data-bs-dismiss="modal"></button>
      </div>
    </div>
  </div>
</div>