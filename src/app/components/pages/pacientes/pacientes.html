<!-- pacientes.html -->

<div class="container-fluid pacientes-page">
  <div class="row mb-4">
    <div class="col">
      <h2 class="mb-0">Pacientes</h2>
      <small class="text-muted">Gerencie os pacientes cadastrados na cl√≠nica</small>
    </div>

    <div class="col-auto d-flex align-items-center">
      <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalCadastroPaciente">
        + Novo Paciente
      </button>
    </div>
  </div>

<!-- Mensagem de alerta -->
  <div *ngIf="mensagemPagPrincipal()!=''" class="alert alert-{{tipoMensagem()}} alert-dismissible fade show">
    <strong>{{mensagemPagPrincipal()}}</strong>
    <button type="button" class="btn-close" aria-label="Close" (click)="mensagemPagPrincipal.set('')"></button>
  </div>
  <!-- LISTA DE PACIENTES -->
  <div class="row">
    <div class="col-12">
      <div class="card">

        <div class="card-header">
          <div class="row align-items-center">
            <!-- T√≠tulo centralizado -->
            <div class="col text-center">
              <span class="fw-bold fs-5">Pacientes cadastrados</span>
            </div>

            <!-- Campo de pesquisa -->
            <div class="col-auto d-flex align-items-center">
              <form [formGroup]="formPesquisar" (ngSubmit)="pesquisarPorNome()" class="d-flex">
                <input type="text" class="form-control search-input" formControlName="nome"
                  placeholder="Pesquisar por nome...">

                <button type="submit" *ngIf="!ativarBodyPesquisa()" class="sidebar-btn ms-2"
                  [disabled]="formPesquisar.invalid">
                  üîç
                </button>
              </form>

              <button type="button" *ngIf="ativarBodyPesquisa()" class="sidebar-btn ms-2"
                (click)="consultarPacientes(0)">
                ‚úñÔ∏è
              </button>
            </div>
          </div>
        </div>

        <!-- TABELA -->
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead class="table-light">
                <!-- TITULO DA TABELA -->
                <tr>
                  <th>Nome</th>
                  <th>CPF</th>
                  <th>WhatsApp</th>
                  <th style="width:180px;">A√ß√µes</th>
                </tr>
              </thead>

              <!-- CORPO DA TABELA -->
              <tbody *ngIf="!ativarBodyPesquisa()">
                <!-- FOR DIN√ÇMICO AO INICIAR A P√ÅG:-->
                <tr *ngFor="let paciente of pacientes()">
                  <td>{{paciente.nomePaciente}}</td>
                  <td>{{aplicarMascaraCPF(paciente.cpfPaciente)}}</td>
                  <td>{{aplicarMascaraWhats(paciente.whatsAppPaciente)}}</td>
                  <td>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                        data-bs-target="#modalEditarPaciente" (click)="abrirEditar(paciente)">
                        Editar
                      </button>
                      <button class="btn btn-sm btn-whatsapp" data-bs-toggle="modal"
                        data-bs-target="#modalDeletePaciente" (click)="abrirEnviarMsg(paciente)">
                        <svg width="16" height="16" viewBox="0 0 32 32" fill="white">
                          <path
                            d="M16 3C9.4 3 4 8.4 4 15c0 2.6.8 5 2.1 7L4 29l7.2-2.1C13.2 28 14.6 28 16 28c6.6 0 12-5.4 12-12S22.6 3 16 3zM16 26c-1.3 0-2.5-.3-3.7-.8l-.3-.1-4.3 1.2 1.2-4.2-.2-.3C7.3 19.7 7 18.4 7 17c0-5 4-9 9-9s9 4 9 9-4 9-9 9zm5.1-6.2c-.3-.2-1.8-.9-2.1-1-.3-.1-.5-.2-.7.2-.2.3-.8 1-1 1.2-.2.2-.4.2-.7.1-.3-.2-1.3-.5-2.4-1.6-.9-.8-1.5-1.8-1.7-2.1-.2-.3 0-.5.1-.7.1-.1.3-.4.5-.6.2-.2.3-.4.4-.6.1-.2 0-.5 0-.7 0-.2-.7-1.7-1-2.3-.3-.6-.6-.5-.8-.5h-.7c-.2 0-.5.1-.7.3-.2.2-1 1-1 2.4s1 2.8 1.2 3.1c.2.3 2 3.3 4.8 4.6 2.8 1.3 2.8.9 3.3.8.5 0 1.6-.6 1.8-1.2.2-.6.2-1.2.2-1.3 0-.1-.3-.2-.6-.4z" />
                        </svg>
                      </button>

                    </div>
                  </td>
                </tr>
              </tbody>

              <tbody *ngIf="ativarBodyPesquisa()">
                <!-- FOR DIN√ÇMICO AO PESQUISAR PACIENTE-->
                <tr *ngFor="let paciente of pacientesFound()">
                  <td>{{paciente.nomePaciente}}</td>
                  <td>{{aplicarMascaraCPF(paciente.cpfPaciente)}}</td>
                  <td>{{aplicarMascaraWhats(paciente.whatsAppPaciente)}}</td>
                  <td>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                        data-bs-target="#modalEditarPaciente" (click)="abrirEditar(paciente)">
                        Editar
                      </button>
                      <button class="btn btn-sm btn-whatsapp" data-bs-toggle="modal"
                        data-bs-target="#modalDeletePaciente" (click)="abrirEnviarMsg(paciente)">
                        <svg width="16" height="16" viewBox="0 0 32 32" fill="white">
                          <path
                            d="M16 3C9.4 3 4 8.4 4 15c0 2.6.8 5 2.1 7L4 29l7.2-2.1C13.2 28 14.6 28 16 28c6.6 0 12-5.4 12-12S22.6 3 16 3zM16 26c-1.3 0-2.5-.3-3.7-.8l-.3-.1-4.3 1.2 1.2-4.2-.2-.3C7.3 19.7 7 18.4 7 17c0-5 4-9 9-9s9 4 9 9-4 9-9 9zm5.1-6.2c-.3-.2-1.8-.9-2.1-1-.3-.1-.5-.2-.7.2-.2.3-.8 1-1 1.2-.2.2-.4.2-.7.1-.3-.2-1.3-.5-2.4-1.6-.9-.8-1.5-1.8-1.7-2.1-.2-.3 0-.5.1-.7.1-.1.3-.4.5-.6.2-.2.3-.4.4-.6.1-.2 0-.5 0-.7 0-.2-.7-1.7-1-2.3-.3-.6-.6-.5-.8-.5h-.7c-.2 0-.5.1-.7.3-.2.2-1 1-1 2.4s1 2.8 1.2 3.1c.2.3 2 3.3 4.8 4.6 2.8 1.3 2.8.9 3.3.8.5 0 1.6-.6 1.8-1.2.2-.6.2-1.2.2-1.3 0-.1-.3-.2-.6-.4z" />
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>

            </table>
          </div>
        </div>

        <!-- PAGINA√á√ÉO DARK PREMIUM -->
        <nav class="pagination-container" *ngIf="ativarBodyPesquisa()==false">
          <ul class="pagination-dark">

            <!-- Bot√£o Anterior -->
            <li>
              <button class="page-btn" [class.disabled]="paginaAtual() === 0" (click)="irParaPagina(paginaAtual() - 1)">
                <i class="bi bi-chevron-left"></i>
              </button>
            </li>

            <!-- N√∫meros -->
            <li *ngFor="let page of totalPaginasArray()">
              <button class="page-btn" [class.active]="page === paginaAtual()" (click)="irParaPagina(page)">
                {{ page + 1 }}
              </button>
            </li>

            <!-- Bot√£o Pr√≥ximo -->
            <li>
              <button class="page-btn" [class.disabled]="paginaAtual() === totalPaginas() - 1"
                (click)="irParaPagina(paginaAtual() + 1)">
                <i class="bi bi-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
<!-- ----------------------------------------------------------------------------------------------------------- -->
<!-- ---------------------------------------------MODAL DE CADASTRO--------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------------------------------- -->
<div class="modal fade" id="modalCadastroPaciente" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <!-- Cabe√ßalho -->
      <div class="modal-header">
        <h5 class="modal-title text-center w-100">Cadastrar Paciente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Corpo (formul√°rio) -->
      <div class="modal-body">
        <form [formGroup]="formAdd" (ngSubmit)="addPaciente()">

          <!-- Nome -->
          <div class="mb-3">
            <label class="form-label">Nome completo</label>
            <input type="text" class="form-control" formControlName="nome"
              (input)="formAdd.get('nome')?.setValue(capitalizarNome($event.target.value), {emitEvent: false})"
              [class.is-invalid]="formAdd.get('nome')?.invalid && formAdd.get('nome')?.touched">

            <div class="invalid-feedback"
              *ngIf="formAdd.get('nome')?.hasError('required') && formAdd.get('nome')?.touched">
              Nome √© obrigat√≥rio.
            </div>
          </div>

          <!-- CPF -->
          <div class="mb-3">
            <label class="form-label">CPF</label>
            <input type="text" class="form-control" formControlName="cpf" mask="000.000.000-00"
              [class.is-invalid]="formAdd.get('cpf')?.invalid && formAdd.get('cpf')?.touched">

            <div class="invalid-feedback"
              *ngIf="formAdd.get('cpf')?.hasError('required') && formAdd.get('cpf')?.touched">
              CPF √© obrigat√≥rio.
            </div>
          </div>

          <!-- WhatsApp -->
          <div class="mb-3">
            <label class="form-label">WhatsApp</label>
            <input type="text" class="form-control" formControlName="whatsApp" mask="(00)00000-0000||(00)0000-0000"
              [class.is-invalid]="formAdd.get('whatsApp')?.invalid && formAdd.get('whatsApp')?.touched">

            <div class="invalid-feedback"
              *ngIf="formAdd.get('whatsApp')?.hasError('required') && formAdd.get('whatsApp')?.touched">
              WhatsApp √© obrigat√≥rio.
            </div>
          </div>

          <!-- Mensagem retorno -->
          <div [ngClass]="{ 'show': mensagemModal() != '' }"
            class="alert alert-{{tipoMensagem()}} alert-dismissible fade show" *ngIf="mensagemModal()!=''">
            <strong>{{mensagemModal()}}</strong>
            <button type="button" class="btn-close" (click)="mensagemModal.set('')"></button>
          </div>

          <!-- Footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" [disabled]="formAdd.invalid" class="btn btn-dark">Salvar</button>

            <!-- Bot√£o escondido para fechar via TS -->
            <button #btnCloseAdd type="button" data-bs-dismiss="modal" class="d-none"></button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>

<!-- ----------------------------------------------------------------------------------------------------------- -->
<!-- ---------------------------------------------MODAL DE EDICAO----------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------------------------------- -->
<div class="modal fade" id="modalEditarPaciente" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <!-- Cabe√ßalho -->
      <div class="modal-header">
        <h5 class="modal-title t text-center w-100">Editar dados do Paciente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Corpo (formul√°rio) -->
      <div class="modal-body">
        <form [formGroup]="formEdit" (ngSubmit)="editarPaciente()">

          <!-- Nome -->
          <div class="mb-3">
            <label class="form-label">Nome completo</label>
            <input type="text" class="form-control" formControlName="nome"
              (input)="formEdit.get('nome')?.setValue(capitalizarNome($event.target.value), { emitEvent: false })"
              [class.is-invalid]="formEdit.get('nome')?.invalid && formEdit.get('nome')?.touched">

            <div class="invalid-feedback"
              *ngIf="formEdit.get('nome')?.hasError('required') && formEdit.get('nome')?.touched">
              Nome √© obrigat√≥rio.
            </div>
          </div>

          <!-- CPF -->
          <div class="mb-3">
            <label class="form-label">CPF</label>
            <input type="text" class="form-control" formControlName="cpf" mask="000.000.000-00"
              [class.is-invalid]="formEdit.get('cpf')?.invalid && formEdit.get('cpf')?.touched">

            <div class="invalid-feedback"
              *ngIf="formEdit.get('cpf')?.hasError('required') && formEdit.get('cpf')?.touched">
              CPF √© obrigat√≥rio.
            </div>
          </div>

          <!-- Telefone / WhatsApp -->
          <div class="mb-3">
            <label class="form-label">WhatsApp</label>
            <input type="text" class="form-control" formControlName="whatsApp" mask="(00)0000-0000||(00)00000-0000"
              [class.is-invalid]="formEdit.get('whatsApp')?.invalid && formEdit.get('whatsApp')?.touched">

            <div class="invalid-feedback"
              *ngIf="formEdit.get('whatsApp')?.hasError('required') && formEdit.get('whatsApp')?.touched">
              WhatsApp √© obrigat√≥rio.
            </div>
          </div>

          <!-- Mensagem retorno -->
          <div [ngClass]="{ 'show': mensagemModal() != '' }"
            class="alert alert-{{ tipoMensagem() }} alert-dismissible fade show" *ngIf="mensagemModal() != ''">
            <strong>{{ mensagemModal() }}</strong>
            <button type="button" class="btn-close" aria-label="Close" (click)="mensagemModal.set('')"></button>
          </div>

          <!-- Rodap√© -->
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
              Cancelar
            </button>

            <button type="submit" class="btn btn-dark" [disabled]="formEdit.invalid">
              Editar
            </button>

            <!-- Bot√£o escondido s√≥ para fechar via TS -->
            <button #btnCloseEdit type="button" class="d-none" data-bs-dismiss="modal"></button>
          </div>

        </form>
      </div>

    </div>
  </div>
</div>

<!-- ----------------------------------------------------------------------------------------------------------- -->
<!-- ---------------------------------------------MODAL DE DELETE----------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------------------------------- -->
<div class="modal fade" id="modalDeletePaciente" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Confirmar envio de mensagem</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p>Deseja enviar mensagem para o paciente <strong>{{pacienteSelecionado?.nomePaciente}}</strong>?</p>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-danger" (click)="EnviarMensagemPaciente()" data-bs-dismiss="modal">Confirmar</button>
      </div>

    </div>
  </div>
</div>